<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>Moperator - Email Infrastructure for AI Agents</title>
  <meta name="title" content="Moperator - Email Infrastructure for AI Agents">
  <meta name="description" content="The first email infrastructure built for AI agents. Connect ChatGPT, Claude, and custom agents to email with intelligent labeling, MCP, OpenAPI, and webhooks.">
  <meta name="keywords" content="AI email, ChatGPT email, Claude email, MCP, AI agents, email API, webhook, LLM email">
  <meta name="author" content="Moperator">
  <meta name="robots" content="index, follow">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="logo.svg">
  <link rel="apple-touch-icon" href="logo.svg">

  <!-- Theme Color -->
  <meta name="theme-color" content="#6366f1">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://app.moperator.work/">
  <meta property="og:title" content="Moperator - Email Infrastructure for AI Agents">
  <meta property="og:description" content="The first email infrastructure built for AI agents. Connect ChatGPT, Claude, and custom agents to email with intelligent labeling and webhooks.">
  <meta property="og:image" content="https://app.moperator.work/og-image.png">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://app.moperator.work/">
  <meta property="twitter:title" content="Moperator - Email Infrastructure for AI Agents">
  <meta property="twitter:description" content="The first email infrastructure built for AI agents. Connect ChatGPT, Claude, and custom agents to email with intelligent labeling and webhooks.">
  <meta property="twitter:image" content="https://app.moperator.work/og-image.png">

  <!-- Canonical -->
  <link rel="canonical" href="https://app.moperator.work/">

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            dark: '#0f172a',
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen" x-data="app()" x-init="init()">

  <!-- Auth Screen (Login/Signup) -->
  <div x-show="!isAuthenticated" x-cloak class="min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 p-8 w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <img src="logo.svg" alt="Moperator" class="h-16 mx-auto mb-4">
        <h1 class="text-2xl font-bold text-slate-800">Welcome to Moperator</h1>
        <p class="text-slate-500 mt-2">Email for AI agents</p>
      </div>

      <!-- Tab Toggle -->
      <div class="flex mb-6 bg-slate-100 rounded-lg p-1">
        <button
          @click="authMode = 'login'"
          :class="authMode === 'login' ? 'bg-white shadow-sm' : ''"
          class="flex-1 py-2 text-sm font-medium rounded-md transition"
        >Login</button>
        <button
          @click="authMode = 'signup'"
          :class="authMode === 'signup' ? 'bg-white shadow-sm' : ''"
          class="flex-1 py-2 text-sm font-medium rounded-md transition"
        >Sign Up</button>
      </div>

      <!-- Login Form -->
      <form x-show="authMode === 'login'" @submit.prevent="login()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
          <input
            type="email"
            x-model="loginForm.email"
            placeholder="you@example.com"
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
          <input
            type="password"
            x-model="loginForm.password"
            placeholder="••••••••"
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
          >
        </div>
        <button
          type="submit"
          :disabled="authLoading"
          class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-indigo-600 transition disabled:opacity-50"
        >
          <span x-show="!authLoading">Login</span>
          <span x-show="authLoading">Logging in...</span>
        </button>
      </form>

      <!-- Signup Form -->
      <form x-show="authMode === 'signup'" @submit.prevent="signup()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
          <input
            type="text"
            x-model="signupForm.name"
            placeholder="Your name"
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
          <input
            type="email"
            x-model="signupForm.email"
            placeholder="you@example.com"
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
          <input
            type="password"
            x-model="signupForm.password"
            placeholder="At least 6 characters"
            required
            minlength="6"
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
          >
        </div>
        <button
          type="submit"
          :disabled="authLoading"
          class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-indigo-600 transition disabled:opacity-50"
        >
          <span x-show="!authLoading">Create Account</span>
          <span x-show="authLoading">Creating...</span>
        </button>
      </form>

      <!-- Error Message -->
      <div x-show="authError" x-cloak class="mt-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm" x-text="authError"></div>
    </div>
  </div>

  <!-- Main App (Authenticated) -->
  <div x-show="isAuthenticated" x-cloak class="min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="logo.svg" alt="Moperator" class="h-8">
          <span class="text-lg font-bold text-slate-800">Moperator</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-sm text-slate-600">
            <span x-text="user?.name || user?.email"></span>
          </div>
          <button
            @click="logout()"
            class="px-3 py-1.5 text-sm text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition"
          >Logout</button>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex gap-1">
          <template x-for="tab in ['inbox', 'labels', 'integrations', 'settings']" :key="tab">
            <button
              @click="currentTab = tab"
              :class="currentTab === tab ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'"
              class="px-4 py-3 text-sm font-medium border-b-2 capitalize transition"
              x-text="tab"
            ></button>
          </template>
        </div>
      </div>
    </nav>

    <!-- Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">

      <!-- Inbox Tab -->
      <div x-show="currentTab === 'inbox'">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold text-slate-800">Inbox</h2>
          <div class="flex gap-2">
            <select
              x-model="labelFilter"
              @change="loadEmails()"
              class="px-3 py-2 border border-slate-300 rounded-lg text-sm"
            >
              <option value="">All Labels</option>
              <template x-for="label in labels" :key="label.id">
                <option :value="label.id" x-text="label.name"></option>
              </template>
            </select>
            <button @click="loadEmails()" class="px-3 py-2 bg-slate-100 rounded-lg text-sm hover:bg-slate-200">
              Refresh
            </button>
          </div>
        </div>

        <!-- Email List -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <template x-if="emails.length === 0">
            <div class="p-8 text-center text-slate-400">
              <p>No emails yet. Send an email to:</p>
              <p class="font-mono text-primary mt-2" x-text="user?.inboxEmail"></p>
            </div>
          </template>
          <template x-for="email in emails" :key="email.id">
            <div
              @click="openEmail(email.id)"
              class="flex items-center gap-4 p-4 border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition"
            >
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-medium text-slate-800 truncate" x-text="email.from"></span>
                  <span class="text-xs text-slate-400" x-text="formatDate(email.receivedAt)"></span>
                </div>
                <div class="text-sm text-slate-600 truncate" x-text="email.subject"></div>
              </div>
              <div class="flex gap-1 flex-wrap">
                <template x-for="label in (email.labels || [])" :key="label">
                  <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full" x-text="label"></span>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Labels Tab -->
      <div x-show="currentTab === 'labels'">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-slate-800">Labels</h2>
            <p class="text-sm text-slate-500">Define labels to classify your emails. Claude uses these descriptions to categorize incoming mail.</p>
          </div>
          <button
            @click="editingLabel = { id: '', name: '', description: '', _isEdit: false }; showLabelModal = true"
            class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-indigo-600 transition"
          >+ New Label</button>
        </div>

        <div class="grid gap-4">
          <template x-for="label in labels" :key="label.id">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
              <div class="flex items-start justify-between">
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-medium text-slate-800" x-text="label.name"></span>
                    <span class="text-xs font-mono text-slate-400" x-text="label.id"></span>
                  </div>
                  <p class="text-sm text-slate-600" x-text="label.description"></p>
                </div>
                <div class="flex gap-2">
                  <button
                    @click="editingLabel = {...label, _isEdit: true}; showLabelModal = true"
                    class="p-1.5 text-slate-400 hover:text-slate-600"
                  >Edit</button>
                  <button
                    @click="deleteLabel(label.id)"
                    class="p-1.5 text-red-400 hover:text-red-600"
                  >Delete</button>
                </div>
              </div>
            </div>
          </template>
          <template x-if="labels.length === 0">
            <div class="bg-white rounded-xl p-8 text-center text-slate-400 border border-slate-200">
              No labels defined. Create one to start classifying emails.
            </div>
          </template>
        </div>
      </div>

      <!-- Integrations Tab -->
      <div x-show="currentTab === 'integrations'">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-slate-800">Integrations</h2>
            <p class="text-sm text-slate-500">Connect AI assistants and agents to your email. Each integration is scoped to specific labels.</p>
          </div>
          <button
            @click="openIntegrationModal()"
            class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-indigo-600"
          >+ New Integration</button>
        </div>

        <!-- Quick Start (Full Access) -->
        <div class="mb-8">
          <h3 class="text-sm font-medium text-slate-500 uppercase tracking-wide mb-3">Quick Start (Full Access)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Claude Desktop -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center text-orange-600 font-bold">C</div>
                <div>
                  <div class="font-medium text-slate-800">Claude Desktop</div>
                  <div class="text-xs text-slate-500">MCP Protocol</div>
                </div>
              </div>
              <p class="text-sm text-slate-600 mb-3">All labels</p>
              <button
                @click="showQuickStart('claude')"
                class="w-full py-2 bg-slate-100 rounded-lg text-sm hover:bg-slate-200"
              >View Setup</button>
            </div>

            <!-- ChatGPT -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600 font-bold">G</div>
                <div>
                  <div class="font-medium text-slate-800">ChatGPT</div>
                  <div class="text-xs text-slate-500">OpenAPI Actions</div>
                </div>
              </div>
              <p class="text-sm text-slate-600 mb-3">All labels</p>
              <button
                @click="showQuickStart('chatgpt')"
                class="w-full py-2 bg-slate-100 rounded-lg text-sm hover:bg-slate-200"
              >View Setup</button>
            </div>

            <!-- REST API -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold">{}</div>
                <div>
                  <div class="font-medium text-slate-800">REST API</div>
                  <div class="text-xs text-slate-500">Direct Access</div>
                </div>
              </div>
              <p class="text-sm text-slate-600 mb-3">All labels</p>
              <button
                @click="showQuickStart('api')"
                class="w-full py-2 bg-slate-100 rounded-lg text-sm hover:bg-slate-200"
              >View Setup</button>
            </div>
          </div>
        </div>

        <!-- Custom Integrations -->
        <div>
          <h3 class="text-sm font-medium text-slate-500 uppercase tracking-wide mb-3">Custom Integrations (Label-Scoped)</h3>
          <div class="space-y-3">
            <template x-for="integration in integrations" :key="integration.id">
              <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="font-medium text-slate-800" x-text="integration.name"></span>
                      <template x-for="protocol in getEnabledProtocols(integration)" :key="protocol">
                        <span class="px-1.5 py-0.5 bg-slate-100 text-slate-600 text-xs rounded" x-text="protocol"></span>
                      </template>
                    </div>
                    <div class="text-sm text-slate-500 mb-2" x-text="integration.description"></div>
                    <div class="flex flex-wrap gap-1">
                      <template x-for="label in (integration.labels || [])" :key="label">
                        <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full" x-text="label"></span>
                      </template>
                      <template x-if="integration.labels?.includes('*')">
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">All Labels</span>
                      </template>
                    </div>
                  </div>
                  <div class="flex gap-2 ml-4">
                    <button @click="viewIntegration(integration)" class="text-xs text-primary hover:text-indigo-700">Config</button>
                    <button @click="editIntegration(integration)" class="text-xs text-slate-500 hover:text-slate-700">Edit</button>
                    <button @click="deleteIntegration(integration.id)" class="text-xs text-red-500 hover:text-red-700">Delete</button>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="integrations.length === 0">
              <div class="bg-white rounded-xl p-8 text-center text-slate-400 border border-slate-200">
                No custom integrations yet. Create one to scope access to specific labels.
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div x-show="currentTab === 'settings'">
        <h2 class="text-lg font-semibold text-slate-800 mb-6">Settings</h2>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Your Inbox Email</label>
            <div class="flex gap-2">
              <input
                type="text"
                :value="user?.inboxEmail"
                readonly
                class="flex-1 px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg text-slate-600"
              >
              <button
                @click="copyToClipboard(user?.inboxEmail)"
                class="px-4 py-2 bg-slate-100 rounded-lg text-sm hover:bg-slate-200"
              >Copy</button>
            </div>
            <p class="text-xs text-slate-500 mt-1">Forward emails here or share this address with services.</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Account ID</label>
            <input
              type="text"
              :value="user?.id"
              readonly
              class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg text-slate-600"
            >
          </div>

          <div class="pt-4 border-t border-slate-200">
            <button
              @click="logout()"
              class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm hover:bg-red-100"
            >Logout</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Label Modal -->
  <div x-show="showLabelModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl" @click.outside="showLabelModal = false">
      <h3 class="text-lg font-semibold mb-4" x-text="editingLabel._isEdit ? 'Edit Label' : 'New Label'"></h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
          <input
            type="text"
            x-model="editingLabel.name"
            @input="if (!editingLabel._isEdit) editingLabel.id = editingLabel.name.toLowerCase().replace(/[^a-z]/g, '')"
            placeholder="Finance & Bills"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg"
          >
        </div>
        <div x-show="editingLabel._isEdit">
          <label class="block text-sm font-medium text-slate-700 mb-1">ID</label>
          <input
            type="text"
            :value="editingLabel.id"
            readonly
            class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-100 text-slate-500 font-mono text-sm"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
          <textarea
            x-model="editingLabel.description"
            placeholder="Describe what emails should get this label..."
            rows="3"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg"
          ></textarea>
          <p class="text-xs text-slate-500 mt-1">Claude uses this description to classify emails.</p>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button @click="showLabelModal = false" class="flex-1 py-2 border border-slate-300 rounded-lg">Cancel</button>
        <button @click="saveLabel()" class="flex-1 py-2 bg-primary text-white rounded-lg">Save</button>
      </div>
    </div>
  </div>

  <!-- Email Detail Modal -->
  <div x-show="selectedEmail" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden shadow-xl" @click.outside="selectedEmail = null">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="font-semibold text-slate-800" x-text="selectedEmail?.email?.subject"></h3>
        <button @click="selectedEmail = null" class="text-slate-400 hover:text-slate-600">✕</button>
      </div>
      <div class="p-4 space-y-3 overflow-y-auto max-h-[60vh]">
        <div class="text-sm">
          <span class="text-slate-500">From:</span>
          <span class="text-slate-800" x-text="selectedEmail?.email?.from"></span>
        </div>
        <div class="text-sm">
          <span class="text-slate-500">To:</span>
          <span class="text-slate-800" x-text="selectedEmail?.email?.to"></span>
        </div>
        <div class="text-sm">
          <span class="text-slate-500">Date:</span>
          <span class="text-slate-800" x-text="selectedEmail?.email?.receivedAt ? new Date(selectedEmail.email.receivedAt).toLocaleString() : ''"></span>
        </div>
        <div class="text-sm">
          <span class="text-slate-500">Labels:</span>
          <template x-for="label in (selectedEmail?.labels || [])" :key="label">
            <span class="ml-1 px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full" x-text="label"></span>
          </template>
        </div>
        <hr class="my-4">
        <div class="whitespace-pre-wrap text-sm text-slate-700" x-text="selectedEmail?.email?.textBody"></div>
      </div>
    </div>
  </div>

  <!-- Integration Modal -->
  <div x-show="showIntegrationModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-xl" @click.outside="showIntegrationModal = false">
      <h3 class="text-lg font-semibold mb-4" x-text="editingIntegration._isEdit ? 'Edit Integration' : 'New Integration'"></h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
          <input
            type="text"
            x-model="editingIntegration.name"
            @input="if (!editingIntegration._isEdit) editingIntegration.id = editingIntegration.name.toLowerCase().replace(/[^a-z]/g, '')"
            placeholder="Finance Bot"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
          <input
            type="text"
            x-model="editingIntegration.description"
            placeholder="What is this integration for?"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Labels (email access scope)</label>
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-lg cursor-pointer transition"
              :class="editingIntegration.labels?.includes('*') ? 'border-primary bg-indigo-50 text-primary' : 'border-slate-200 hover:border-slate-300'"
              @click="editingIntegration.labels = editingIntegration.labels?.includes('*') ? [] : ['*']">
              <span class="text-sm">All Labels</span>
            </label>
            <template x-for="label in labels" :key="label.id">
              <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-lg cursor-pointer transition"
                :class="editingIntegration.labels?.includes(label.id) ? 'border-primary bg-indigo-50 text-primary' : 'border-slate-200 hover:border-slate-300'">
                <input type="checkbox" :value="label.id" x-model="editingIntegration.labels" class="hidden" :disabled="editingIntegration.labels?.includes('*')">
                <span class="text-sm" x-text="label.name"></span>
              </label>
            </template>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Protocols</label>
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-lg cursor-pointer transition"
              :class="editingIntegration.mcp ? 'border-primary bg-indigo-50 text-primary' : 'border-slate-200 hover:border-slate-300'">
              <input type="checkbox" x-model="editingIntegration.mcp" class="hidden">
              <span class="text-sm">MCP (Claude)</span>
            </label>
            <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-lg cursor-pointer transition"
              :class="editingIntegration.openapi ? 'border-primary bg-indigo-50 text-primary' : 'border-slate-200 hover:border-slate-300'">
              <input type="checkbox" x-model="editingIntegration.openapi" class="hidden">
              <span class="text-sm">OpenAPI (ChatGPT)</span>
            </label>
            <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-lg cursor-pointer transition"
              :class="editingIntegration.webhook ? 'border-primary bg-indigo-50 text-primary' : 'border-slate-200 hover:border-slate-300'">
              <input type="checkbox" x-model="editingIntegration.webhook" class="hidden">
              <span class="text-sm">Webhook</span>
            </label>
            <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-lg cursor-pointer transition"
              :class="editingIntegration.api ? 'border-primary bg-indigo-50 text-primary' : 'border-slate-200 hover:border-slate-300'">
              <input type="checkbox" x-model="editingIntegration.api" class="hidden">
              <span class="text-sm">REST API</span>
            </label>
          </div>
        </div>
        <div x-show="editingIntegration.webhook">
          <label class="block text-sm font-medium text-slate-700 mb-1">Webhook URL</label>
          <input
            type="url"
            x-model="editingIntegration.webhookUrl"
            placeholder="https://your-server.com/webhook"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm"
          >
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button @click="showIntegrationModal = false" class="flex-1 py-2 border border-slate-300 rounded-lg">Cancel</button>
        <button @click="saveIntegration()" class="flex-1 py-2 bg-primary text-white rounded-lg">Save</button>
      </div>
    </div>
  </div>

  <!-- Quick Start Modal -->
  <div x-show="quickStartType" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-xl shadow-xl" @click.outside="quickStartType = null">
      <!-- Claude Desktop -->
      <template x-if="quickStartType === 'claude'">
        <div>
          <h3 class="text-lg font-semibold mb-4">Claude Desktop Setup (MCP)</h3>
          <ol class="text-sm text-slate-600 mb-4 list-decimal list-inside space-y-1">
            <li>Open Claude Desktop settings</li>
            <li>Go to Developer → Edit Config</li>
            <li>Add this to your config file:</li>
          </ol>
          <div class="bg-slate-900 text-slate-100 rounded-lg p-4 text-sm font-mono overflow-x-auto">
            <pre x-text="getMCPConfig()"></pre>
          </div>
          <div class="flex gap-2 mt-4">
            <button @click="copyToClipboard(getMCPConfig())" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">Copy Config</button>
            <button @click="quickStartType = null" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">Close</button>
          </div>
          <p class="text-xs text-slate-500 mt-4">After adding, restart Claude Desktop. Then ask: "Check my email"</p>
        </div>
      </template>

      <!-- ChatGPT -->
      <template x-if="quickStartType === 'chatgpt'">
        <div>
          <h3 class="text-lg font-semibold mb-4">ChatGPT Setup (OpenAPI Actions)</h3>
          <ol class="text-sm text-slate-600 mb-4 list-decimal list-inside space-y-2">
            <li>Go to <a href="https://chat.openai.com/gpts/editor" target="_blank" class="text-primary hover:underline">chat.openai.com/gpts/editor</a></li>
            <li>Create a new GPT or edit existing one</li>
            <li>Go to "Configure" → "Actions" → "Create new action"</li>
            <li>Click "Import from URL" and paste this URL:</li>
          </ol>
          <div class="bg-slate-100 rounded-lg p-3 font-mono text-sm break-all" x-text="apiBase + '/openapi.json'"></div>
          <ol start="5" class="text-sm text-slate-600 my-4 list-decimal list-inside space-y-2">
            <li>Set Authentication to "API Key"</li>
            <li>Auth Type: "Bearer"</li>
            <li>Paste your API key:</li>
          </ol>
          <div class="bg-slate-100 rounded-lg p-3 font-mono text-sm break-all" x-text="apiKey"></div>
          <div class="flex gap-2 mt-4">
            <button @click="copyToClipboard(apiBase + '/openapi.json')" class="px-4 py-2 bg-slate-100 rounded-lg text-sm">Copy URL</button>
            <button @click="copyToClipboard(apiKey)" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">Copy API Key</button>
            <button @click="quickStartType = null" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">Close</button>
          </div>
        </div>
      </template>

      <!-- REST API -->
      <template x-if="quickStartType === 'api'">
        <div>
          <h3 class="text-lg font-semibold mb-4">REST API Access</h3>
          <p class="text-sm text-slate-600 mb-4">Use this API key for direct API access:</p>
          <div class="bg-slate-100 rounded-lg p-3 font-mono text-sm break-all" x-text="apiKey"></div>
          <div class="mt-4 text-sm text-slate-600">
            <p class="font-medium mb-2">Example API calls:</p>
            <div class="bg-slate-900 text-slate-100 rounded-lg p-4 font-mono text-xs space-y-2 overflow-x-auto">
              <div class="text-slate-400"># List all emails</div>
              <div>curl -H "Authorization: Bearer $API_KEY" \</div>
              <div class="pl-4" x-text="apiBase + '/api/v1/emails'"></div>
              <div class="text-slate-400 mt-3"># Filter by label</div>
              <div x-text="'curl -H \"Authorization: Bearer $API_KEY\" \"' + apiBase + '/api/v1/emails?labels=finance\"'"></div>
            </div>
          </div>
          <div class="flex gap-2 mt-4">
            <button @click="copyToClipboard(apiKey)" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">Copy API Key</button>
            <button @click="quickStartType = null" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">Close</button>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Integration Config Modal -->
  <div x-show="viewingIntegration" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-xl shadow-xl" @click.outside="viewingIntegration = null">
      <h3 class="text-lg font-semibold mb-4" x-text="viewingIntegration?.name + ' Configuration'"></h3>

      <div class="space-y-4">
        <div>
          <div class="text-sm font-medium text-slate-700 mb-1">Scoped API Key</div>
          <div class="bg-slate-100 rounded-lg p-3 font-mono text-sm break-all" x-text="viewingIntegration?.apiKey || 'Not generated'"></div>
          <button @click="copyToClipboard(viewingIntegration?.apiKey)" class="mt-2 px-3 py-1.5 bg-slate-200 rounded text-sm">Copy</button>
        </div>

        <template x-if="viewingIntegration?.mcp">
          <div>
            <div class="text-sm font-medium text-slate-700 mb-1">MCP Config (Claude Desktop)</div>
            <div class="bg-slate-900 text-slate-100 rounded-lg p-3 font-mono text-xs overflow-x-auto">
              <pre x-text="getIntegrationMCPConfig(viewingIntegration)"></pre>
            </div>
            <button @click="copyToClipboard(getIntegrationMCPConfig(viewingIntegration))" class="mt-2 px-3 py-1.5 bg-slate-200 rounded text-sm">Copy</button>
          </div>
        </template>

        <template x-if="viewingIntegration?.openapi">
          <div>
            <div class="text-sm font-medium text-slate-700 mb-1">OpenAPI URL (ChatGPT)</div>
            <div class="bg-slate-100 rounded-lg p-3 font-mono text-sm break-all" x-text="apiBase + '/openapi.json'"></div>
            <p class="text-xs text-slate-500 mt-1">Use the scoped API key above for authentication</p>
          </div>
        </template>

        <template x-if="viewingIntegration?.webhook">
          <div>
            <div class="text-sm font-medium text-slate-700 mb-1">Webhook URL</div>
            <div class="bg-slate-100 rounded-lg p-3 font-mono text-sm break-all" x-text="viewingIntegration?.webhookUrl || 'Not configured'"></div>
          </div>
        </template>

        <div>
          <div class="text-sm font-medium text-slate-700 mb-1">Labels (Scope)</div>
          <div class="flex flex-wrap gap-1">
            <template x-for="label in (viewingIntegration?.labels || [])" :key="label">
              <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full" x-text="label === '*' ? 'All Labels' : label"></span>
            </template>
          </div>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button @click="viewingIntegration = null" class="flex-1 py-2 border border-slate-300 rounded-lg">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div x-show="toast" x-cloak class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg" x-text="toast"></div>

  <script>
    function app() {
      return {
        // Auth state
        isAuthenticated: false,
        authMode: 'login',
        authLoading: false,
        authError: '',
        loginForm: { email: '', password: '' },
        signupForm: { name: '', email: '', password: '' },

        // User data
        user: null,
        apiKey: '',
        apiBase: 'https://api.moperator.work',

        // App state
        currentTab: 'inbox',
        loading: false,
        emails: [],
        labels: [],
        labelFilter: '',
        selectedEmail: null,
        showLabelModal: false,
        editingLabel: { id: '', name: '', description: '' },
        integrations: [],
        showIntegrationModal: false,
        editingIntegration: { id: '', name: '', description: '', labels: [], mcp: false, openapi: false, webhook: false, api: false, webhookUrl: '' },
        viewingIntegration: null,
        quickStartType: null,
        toast: '',

        init() {
          // Check for stored session
          const stored = localStorage.getItem('moperator_session');
          if (stored) {
            try {
              const session = JSON.parse(stored);
              this.user = session.user;
              this.apiKey = session.apiKey;
              this.isAuthenticated = true;
              this.loadData();
            } catch (e) {
              localStorage.removeItem('moperator_session');
            }
          }
        },

        async login() {
          this.authLoading = true;
          this.authError = '';

          try {
            const res = await fetch(`${this.apiBase}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.loginForm)
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.error || 'Login failed');
            }

            this.user = data.tenant;
            this.apiKey = data.apiKey;
            this.isAuthenticated = true;

            localStorage.setItem('moperator_session', JSON.stringify({
              user: this.user,
              apiKey: this.apiKey
            }));

            this.loadData();
            this.showToast('Welcome back!');
          } catch (err) {
            this.authError = err.message;
          } finally {
            this.authLoading = false;
          }
        },

        async signup() {
          this.authLoading = true;
          this.authError = '';

          try {
            const res = await fetch(`${this.apiBase}/auth/signup`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.signupForm)
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.error || 'Signup failed');
            }

            this.user = data.tenant;
            this.apiKey = data.apiKey;
            this.isAuthenticated = true;

            localStorage.setItem('moperator_session', JSON.stringify({
              user: this.user,
              apiKey: this.apiKey
            }));

            this.loadData();
            this.showToast('Account created! Your inbox: ' + this.user.inboxEmail);
          } catch (err) {
            this.authError = err.message;
          } finally {
            this.authLoading = false;
          }
        },

        logout() {
          this.isAuthenticated = false;
          this.user = null;
          this.apiKey = '';
          this.emails = [];
          this.labels = [];
          localStorage.removeItem('moperator_session');
          this.showToast('Logged out');
        },

        async loadData() {
          this.loading = true;
          try {
            await this.loadLabels();
            await this.loadEmails();
            await this.loadIntegrations();
          } catch (err) {
            console.error('Failed to load data:', err);
          } finally {
            this.loading = false;
          }
        },

        async loadEmails() {
          try {
            let url = `${this.apiBase}/api/v1/emails?limit=50`;
            if (this.labelFilter) {
              url += `&labels=${this.labelFilter}`;
            }
            const res = await fetch(url, {
              headers: { 'Authorization': `Bearer ${this.apiKey}` }
            });
            const data = await res.json();
            this.emails = data.emails || [];
          } catch (err) {
            console.error('Failed to load emails:', err);
          }
        },

        async openEmail(emailId) {
          try {
            const res = await fetch(`${this.apiBase}/api/v1/emails/${emailId}`, {
              headers: { 'Authorization': `Bearer ${this.apiKey}` }
            });
            if (!res.ok) throw new Error('Failed to load email');
            const data = await res.json();
            this.selectedEmail = data;
          } catch (err) {
            this.showToast('Failed to load email');
          }
        },

        async loadLabels() {
          try {
            const res = await fetch(`${this.apiBase}/api/v1/labels`, {
              headers: { 'Authorization': `Bearer ${this.apiKey}` }
            });
            const data = await res.json();
            this.labels = data.labels || [];
          } catch (err) {
            console.error('Failed to load labels:', err);
          }
        },

        async saveLabel() {
          if (!this.editingLabel.id || !this.editingLabel.name || !this.editingLabel.description) {
            this.showToast('Please fill in all fields');
            return;
          }

          try {
            const isNew = !this.labels.find(l => l.id === this.editingLabel.id);
            const method = isNew ? 'POST' : 'PUT';
            const url = isNew
              ? `${this.apiBase}/api/v1/labels`
              : `${this.apiBase}/api/v1/labels/${this.editingLabel.id}`;

            const res = await fetch(url, {
              method,
              headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(this.editingLabel)
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Failed to save label');
            }

            await this.loadLabels();
            this.showLabelModal = false;
            this.showToast('Label saved');
          } catch (err) {
            this.showToast(err.message);
          }
        },

        async deleteLabel(id) {
          if (!confirm('Delete this label? This will not affect existing emails.')) return;

          try {
            const res = await fetch(`${this.apiBase}/api/v1/labels/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${this.apiKey}` }
            });

            if (!res.ok) throw new Error('Failed to delete');

            await this.loadLabels();
            this.showToast('Label deleted');
          } catch (err) {
            this.showToast(err.message);
          }
        },

        async loadIntegrations() {
          try {
            const res = await fetch(`${this.apiBase}/api/v1/integrations`, {
              headers: { 'Authorization': `Bearer ${this.apiKey}` }
            });
            const data = await res.json();
            this.integrations = data.integrations || [];
          } catch (err) {
            console.error('Failed to load integrations:', err);
          }
        },

        openIntegrationModal() {
          this.editingIntegration = { id: '', name: '', description: '', labels: [], mcp: false, openapi: false, webhook: false, api: false, webhookUrl: '' };
          this.showIntegrationModal = true;
        },

        editIntegration(integration) {
          this.editingIntegration = { ...integration, _isEdit: true };
          this.showIntegrationModal = true;
        },

        viewIntegration(integration) {
          this.viewingIntegration = integration;
        },

        async saveIntegration() {
          if (!this.editingIntegration.name) {
            this.showToast('Please enter a name');
            return;
          }

          if (!this.editingIntegration.labels || this.editingIntegration.labels.length === 0) {
            this.showToast('Please select at least one label');
            return;
          }

          if (!this.editingIntegration.mcp && !this.editingIntegration.openapi && !this.editingIntegration.webhook && !this.editingIntegration.api) {
            this.showToast('Please enable at least one protocol');
            return;
          }

          if (this.editingIntegration.webhook && !this.editingIntegration.webhookUrl) {
            this.showToast('Please enter a webhook URL');
            return;
          }

          try {
            const isNew = !this.editingIntegration._isEdit;
            const method = isNew ? 'POST' : 'PUT';
            const url = isNew
              ? `${this.apiBase}/api/v1/integrations`
              : `${this.apiBase}/api/v1/integrations/${this.editingIntegration.id}`;

            const payload = {
              id: this.editingIntegration.id,
              name: this.editingIntegration.name,
              description: this.editingIntegration.description || '',
              labels: this.editingIntegration.labels,
              mcp: this.editingIntegration.mcp,
              openapi: this.editingIntegration.openapi,
              webhook: this.editingIntegration.webhook,
              api: this.editingIntegration.api,
              webhookUrl: this.editingIntegration.webhookUrl || ''
            };

            const res = await fetch(url, {
              method,
              headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Failed to save integration');
            }

            await this.loadIntegrations();
            this.showIntegrationModal = false;
            this.showToast('Integration saved');
          } catch (err) {
            this.showToast(err.message);
          }
        },

        async deleteIntegration(id) {
          if (!confirm('Delete this integration?')) return;

          try {
            const res = await fetch(`${this.apiBase}/api/v1/integrations/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${this.apiKey}` }
            });

            if (!res.ok) throw new Error('Failed to delete');

            await this.loadIntegrations();
            this.showToast('Integration deleted');
          } catch (err) {
            this.showToast(err.message);
          }
        },

        getEnabledProtocols(integration) {
          const protocols = [];
          if (integration.mcp) protocols.push('MCP');
          if (integration.openapi) protocols.push('OpenAPI');
          if (integration.webhook) protocols.push('Webhook');
          if (integration.api) protocols.push('API');
          return protocols;
        },

        showQuickStart(type) {
          this.quickStartType = type;
        },

        getIntegrationMCPConfig(integration) {
          if (!integration) return '';
          return JSON.stringify({
            "mcpServers": {
              ["moperator-" + integration.id]: {
                "command": "npx",
                "args": ["-y", "mcp-remote", this.apiBase + "/mcp", "--header", "Authorization: Bearer " + integration.apiKey]
              }
            }
          }, null, 2);
        },

        getMCPConfig() {
          return JSON.stringify({
            "mcpServers": {
              "moperator": {
                "command": "npx",
                "args": ["-y", "mcp-remote", this.apiBase + "/mcp", "--header", "Authorization: Bearer " + this.apiKey]
              }
            }
          }, null, 2);
        },

        formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          const now = new Date();
          const diff = now - date;

          if (diff < 86400000) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } else if (diff < 604800000) {
            return date.toLocaleDateString([], { weekday: 'short' });
          } else {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
          }
        },

        copyToClipboard(text) {
          navigator.clipboard.writeText(text);
          this.showToast('Copied to clipboard');
        },

        showToast(message) {
          this.toast = message;
          setTimeout(() => this.toast = '', 3000);
        }
      };
    }
  </script>
</body>
</html>
